From a6f486a76edbcd8b184086705b3b139dad553f4b Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Thu, 4 May 2017 03:32:45 +0100
Subject: [PATCH] sfnt: Backport fixes for CVE-2017-7857

Upstream: 7bbb91fbf47fc0775cc9705673caf0c47a81f94b
https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=759

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 src/sfnt/sfobjs.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/sfnt/sfobjs.c b/src/sfnt/sfobjs.c
index 818009e..3fd419e 100644
--- a/src/sfnt/sfobjs.c
+++ b/src/sfnt/sfobjs.c
@@ -986,7 +986,9 @@
         face->variation_support |= TT_FACE_FLAG_VAR_FVAR;
 
       /* we don't support Multiple Master CFFs yet */
-      if ( !face->goto_table( face, TTAG_CFF, stream, 0 ) )
+      if ( face->goto_table( face, TTAG_glyf, stream, 0 ) &&
+           face->goto_table( face, TTAG_CFF2, stream, 0 ) &&
+           !face->goto_table( face, TTAG_CFF, stream, 0 ) )
         num_instances = 0;
 
       /* we support at most 2^15 - 1 instances */
-- 
2.12.2

